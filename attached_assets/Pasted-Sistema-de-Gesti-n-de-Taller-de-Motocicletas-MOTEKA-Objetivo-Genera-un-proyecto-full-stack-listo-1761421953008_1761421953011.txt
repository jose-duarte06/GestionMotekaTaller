Sistema de Gestión de Taller de Motocicletas (MOTEKA)”
Objetivo

Genera un proyecto full-stack listo para correr, con Backend (Flask + PostgreSQL) y Frontend (Vite + React + TypeScript) que implemente un sistema de gestión para taller de motocicletas llamado MOTEKA, siguiendo fielmente los requisitos, arquitectura, estilo y convenciones descritas aquí. Entrega el código en una carpeta raíz llamada Gestion_MOTEKA con dos subcarpetas Backend y Frontend.

El resultado debe ser funcional, probado localmente, documentado y autocontenible (con scripts de arranque, dependencias fijadas, seed opcional y reportes exportables).

Stack y versiones requeridas
Backend

Python 3.11+ (compatible 3.13)

Flask 3.x

Flask-SQLAlchemy 3.x + SQLAlchemy 2.x

Flask-Migrate 4.x (Alembic)

Flask-CORS 4.x

Flask-JWT-Extended 4.7.x

psycopg 3.x (NO psycopg2; usar psycopg[binary])

python-dotenv 1.x

Reportes: openpyxl (XLSX) y reportlab (PDF)

Base de datos

PostgreSQL 14+

Nombre de la BD: moteka_db

Frontend

Node 18+

Vite 5.x + React 18 + TypeScript

Axios 1.x

react-router-dom 6.x

Tailwind opcional (puedes usar CSS plano; se debe replicar el diseño del login provisto)

Rutas protegidas con layouts (público/privado)

Arquitectura de carpetas (obligatoria)
Gestion_MOTEKA/
  Backend/
    app.py
    .env.example
    requirements.txt
    migrations/
    core/
      __init__.py
      config.py
      extensions.py
      auth.py
    models/
      __init__.py
      catalogos.py
      personas.py
      vehiculos.py
      ordenes.py
    api/
      __init__.py
      auth_routes.py
      marcas_routes.py
      modelos_routes.py
      clientes_routes.py
      motos_routes.py
      ordenes_routes.py
      reportes_routes.py
  Frontend/
    index.html
    tsconfig.json
    vite.config.ts
    package.json
    .env.example
    src/
      main.tsx
      router.tsx
      index.css
      diseños CSS/
        login.css
      lib/
        api.ts
        auth.ts
      components/
        AppIcon.tsx
        RequireAuth.tsx
      layouts/
        PublicLayout.tsx
        AuthLayout.tsx
      pages/
        Login.tsx
        Home.tsx
        Marcas.tsx
        Modelos.tsx
        Clientes.tsx
        Motos.tsx
        Ordenes.tsx

Configuración (variables de entorno)
Backend .env
DATABASE_URL=postgresql+psycopg://postgres:admin@localhost:5432/moteka_db
JWT_SECRET_KEY=admin
FLASK_ENV=development
CORS_ORIGINS=http://localhost:5173,http://127.0.0.1:5173

Frontend .env
VITE_API_URL=http://localhost:5000

Requisitos funcionales
Catálogos

Marcas (MarcaMoto)

id, nombre (único, no nulo), creado_en, actualizado_en

CRUD completo. Borrado solo si no tiene modelos.

Modelos (ModeloMoto)

id, nombre (no nulo), marca_id FK → Marca, creado_en, actualizado_en

UNIQUE (marca_id, nombre)

CRUD completo. Borrado solo si no tiene motocicletas.

Personas y usuarios

Clientes

id, nombre (no nulo), telefono, correo (único opcional), direccion, timestamps

CRUD + búsqueda por q (nombre/telefono/correo con ilike)

Empleados

id, nombre, activo (bool), timestamps

CRUD

Roles

id, nombre (valores: gerente, encargado, mecanico), UNIQUE(nombre)

Usuarios

id, usuario (único), correo (único opcional), contrasena_hash, rol_id FK → Roles, empleado_id FK opcional, timestamps

Auth con JWT (login + register).

register permitido inicialmente para crear admin; luego restringir por rol (gerente).

Vehículos

Motocicletas

id, cliente_id FK → Clientes (obligatorio)

modelo_id FK → ModeloMoto (opcional)

placa (único opcional), vin (único opcional)

anio (int), cilindraje_cc (int), color, kilometraje_km (int), ultima_revision (date), notas, timestamps

Listado con filtros: cliente_id, cliente_nombre, modelo_id, marca_id, placa, vin, q (placa/vin/color)

Al serializar incluir: cliente, modelo, marca (por join seguro)

Órdenes de trabajo

OrdenTrabajo

id, cliente_id, motocicleta_id, mecanico_asignado_id opcional

estado (enum): EN_ESPERA, EN_REPARACION, FINALIZADA, CANCELADA

fecha_ingreso (datetime, default ahora), fecha_salida (datetime nullable)

observaciones, timestamps

Reglas:

La motocicleta debe pertenecer al cliente.

Cambio a FINALIZADA o CANCELADA → setear fecha_salida si no existe.

No permitir eliminar si tiene pagos.

EstadoOrden (historial)

id, orden_id FK, estado (enum), notas, creado_en (datetime default ahora)

Cada cambio de estado inserta un registro en historial.

Pagos

id, orden_id FK, tipo (enum: EFECTIVO, TARJETA, TRANSFERENCIA), monto (Decimal), pagado_en (datetime)

Validar monto > 0.

Reportes

Reportes de Órdenes

Endpoint /api/reportes/ordenes?formato=csv|xlsx|pdf con los mismos filtros que /api/ordenes

CSV: UTF-8 con BOM; XLSX: autosize básico; PDF: tabla horizontal A4 (si PDF falla, fallback a CSV)

Autenticado y rol gerente o encargado.

CORS

Permitir http://localhost:5173 y http://127.0.0.1:5173

Incluir Authorization y Content-Type

Modelo de datos (DDL aproximado)

Implementar con SQLAlchemy + Alembic. Campos creado_en y actualizado_en en entidades principales.

roles (id, nombre UNIQUE)

usuarios (id, usuario UNIQUE, correo UNIQUE NULL, contrasena_hash, rol_id FK, empleado_id FK NULL, creado_en, actualizado_en)

empleados (id, nombre, activo bool, creado_en, actualizado_en)

clientes (id, nombre, telefono, correo UNIQUE NULL, direccion, creado_en, actualizado_en)

marcas_moto (id, nombre UNIQUE, creado_en, actualizado_en)

modelos_moto (id, nombre, marca_id FK, UNIQUE (marca_id, nombre), creado_en, actualizado_en)

motocicletas (id, cliente_id FK, modelo_id FK NULL, placa UNIQUE NULL, vin UNIQUE NULL, anio int, cilindraje_cc int, color, kilometraje_km int default 0, ultima_revision date NULL, notas, creado_en, actualizado_en)

ordenes_trabajo (id, cliente_id FK, motocicleta_id FK, mecanico_asignado_id FK NULL, estado enum, fecha_ingreso datetime, fecha_salida datetime NULL, observaciones, creado_en, actualizado_en)

estados_orden (id, orden_id FK, estado enum, notas, creado_en datetime)

pagos (id, orden_id FK, tipo enum, monto decimal(12,2), pagado_en datetime)

API (endpoints y reglas)

Prefijo común: /api. Todas las respuestas JSON. Mensajes en español.

Auth

POST /api/auth/register → crea usuario (solo gerente una vez productivo; inicialmente permitir crear admin si no hay usuarios)

body: { usuario, correo?, contrasena, rol_id, empleado_id? }

POST /api/auth/login → { usuario, contrasena }

resp: { access_token, user: { id, usuario, rol } }

El sub del JWT debe ser un string (p.ej. JSON serializado) o usar additional_claims.

GET /api/auth/me → devuelve payload del usuario autenticado

POST /api/auth/logout → opcional (front limpia storage)

Roles

GET /api/roles

POST /api/roles [solo gerente]

DELETE /api/roles/:id [solo gerente]

Marcas / Modelos

GET /api/marcas?q=...

POST /api/marcas [gerente/encargado]

PUT /api/marcas/:id [gerente/encargado]

DELETE /api/marcas/:id (si no tiene modelos)

GET /api/modelos?marca_id=&q=...

POST /api/modelos [gerente/encargado]

PUT /api/modelos/:id [gerente/encargado]

DELETE /api/modelos/:id (si no tiene motos)

Clientes

GET /api/clientes?q=...

POST /api/clientes [gerente/encargado]

PUT /api/clientes/:id [gerente/encargado]

DELETE /api/clientes/:id (si no tiene motos)

Motocicletas

GET /api/motocicletas?cliente_id=&cliente_nombre=&modelo_id=&marca_id=&placa=&vin=&q=...

Devolver campos enriquecidos: cliente, modelo, marca

POST /api/motocicletas [gerente/encargado]

Validar cliente_id existe

modelo_id opcional pero válido

placa/vin únicos si están presentes

PUT /api/motocicletas/:id [gerente/encargado]

No permitir cambiar cliente_id

DELETE /api/motocicletas/:id [gerente/encargado]

Si tiene órdenes → 409

Órdenes

GET /api/ordenes?cliente_id=&cliente_nombre=&motocicleta_id=&mecanico_id=&estado=&desde=&hasta=&placa=&q=...

POST /api/ordenes [gerente/encargado/mecanico]

Validar que la moto pertenezca al cliente

PATCH /api/ordenes/:id/estado [gerente/encargado/mecanico]

Cambia estado; registra en estados_orden; setea fecha_salida si finaliza/cancela

GET /api/ordenes/:id/historial

POST /api/ordenes/:id/pagos [gerente/encargado]

{ tipo, monto } (monto > 0)

DELETE /api/ordenes/:id [gerente/encargado] (si no tiene pagos)

Reportes

GET /api/reportes/ordenes?formato=csv|xlsx|pdf [gerente/encargado]

Mismos filtros que /api/ordenes

CSV UTF-8 con BOM; XLSX (openpyxl) con autosize; PDF (reportlab) horizontal

Seguridad

JWT HS256; JWT_SECRET_KEY en .env.

@jwt_required() en endpoints que no sean públicos.

Decorador @role_required("gerente","encargado",...) para rutas restringidas.

Manejo de errores uniforme (404, 409, 400, 401) con mensajes legibles.

Frontend — Requisitos de UI/UX
Ruteo / layouts

PublicLayout (pantalla completa, fondo oscuro, sin header) para /login

AuthLayout (con header y nav) para el resto.

RequireAuth: si no hay token válido → redirige a /login.

Guard opcional por rol (ej. menú Usuarios solo para gerente).

Login (como la maqueta)

Diseño oscuro, centrado, sin bordes blancos (CSS en diseños CSS/login.css).

Campos: usuario/correo y contraseña; “Recordar sesión”; manejo de error.

Al login exitoso: guardar token y user en localStorage o sessionStorage según “recordar”.

Páginas CRUD

Marcas: lista + crear/editar/eliminar, validando duplicados.

Modelos: lista filtrable por marca; crear/editar/eliminar.

Clientes: búsqueda por nombre/teléfono/correo; crear/editar/eliminar.

Motocicletas:

Form con cliente (buscador por nombre), modelo (opcional), placa/vin (únicos), anio, cilindraje, color, km, última revisión, notas.

Lista con filtros (cliente_nombre, marca_id, modelo_id, placa, vin, q).

Mostrar marca/modelo en tabla.

Órdenes:

Filtros: cliente por nombre (auto-suggest), placa, estado (dropdown con EN_ESPERA, EN_REPARACION, FINALIZADA, CANCELADA).

Crear orden: seleccionar cliente → cargar motos de ese cliente → observaciones.

Cambiar estado (select en tabla) → refrescar lista y, si soloAbiertas activo, ocultar finalizadas/canceladas.

Historial modal (lista cronológica).

Botón “Exportar” con opciones CSV/XLSX/PDF (llama a /api/reportes/ordenes).

Librerías front

Axios con interceptor (Authorization: Bearer <token>).

lib/auth.ts con:

setSession(token, user, remember)

getToken(), getUser(), clearSession()

isAuthed(), isTokenExpired() (parse exp)

hasRole(...roles)

lib/api.ts:

import axios, { type InternalAxiosRequestConfig } from 'axios';
import { getToken } from './auth';

const api = axios.create({
  baseURL: import.meta.env.VITE_API_URL ?? 'http://localhost:5000',
});

api.interceptors.request.use((config: InternalAxiosRequestConfig) => {
  const token = getToken();
  if (token) {
    config.headers = config.headers ?? {};
    (config.headers as any).Authorization = `Bearer ${token}`;
  }
  return config;
});

export default api;

Estilos

body { margin: 0 }

PublicLayout: fondo oscuro con gradiente radial + centrado.

Login card sin borde, solo sombra.

Migraciones y seed

Alembic:

cd Backend
flask --app app.py db init        # solo la primera vez
flask --app app.py db migrate -m "base"
flask --app app.py db upgrade


Seed opcional:

Crear roles gerente, encargado, mecanico

Crear usuario admin: usuario=admin, rol=gerente (contraseña configurable o .env.SEED_ADMIN_PASS)

Comandos para correr
Backend
cd Backend
python -m venv .venv
.\.venv\Scripts\activate
pip install -r requirements.txt

# crear BD moteka_db en Postgres antes
flask --app app.py db upgrade
flask --app app.py run --debug

Frontend
cd Frontend
npm install
npm run dev

Validaciones clave

Mensajes en español (ej. “cliente_id requerido”, “Ya existe la placa ‘XYZ’”, “La motocicleta no pertenece al cliente”, “No puede eliminar la orden: tiene pagos registrados”).

El error Subject must be a string no debe ocurrir: el sub del JWT es string con JSON del usuario o usar additional_claims.

CORS correcto.

Búsquedas ilike y joins seguros (no asumir relationships si no están configuradas).

Aceptación (pruebas mínimas)
Auth

Registro admin (si vacío) → 201

Login admin → 200 + access_token válido

/api/auth/me con token → 200 con datos

Marcas/Modelos

Crear marca “Honda” → 201

Crear modelo “CBR 600” (marca Honda) → 201

Duplicar nombre en misma marca → 409

Clientes/Motos

Crear cliente “Melissa Vargas” → 201

Crear moto con cliente_id y placa única → 201

Listar por cliente_nombre=Melissa → incluye moto

Eliminar marca con modelos → 409

Órdenes

Crear orden con cliente y su moto → 201

Cambiar estado a EN_REPARACION → 200 + historial

Cambiar estado a FINALIZADA → setea fecha_salida

Eliminar orden con pagos → 409

Reportes

CSV/XLSX/PDF descargan con filtros aplicados

Estilo de código y comentarios

Código claro, comentado, en español cuando aplique.

Elimina comentarios redundantes/confusos; explica reglas de negocio y validaciones clave.

Nombres de columnas y mensajes en español (consistentes con lo anterior).

Entregables

Repositorio con la estructura exacta pedida.

README.md en la raíz con:

Requisitos, setup, variables de entorno, comandos para correr, flujo de login, exportes de reportes.

Endpoints listados con ejemplos curl y respuestas esperadas.

Capturas o GIF opcional del login y una pantalla CRUD.

Notas finales

Prioriza robustez (validaciones) y coherencia (nombres en español).

El login debe verse sin header y sin bordes (usa diseños CSS/login.css).

Asegura que Órdenes refresque al cambiar estado y oculte finalizadas/canceladas si la UI tiene “Solo abiertas”.